<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>合同管理</title>


		<!-- Vue.js -->
		<script src="https://cdn.jsdelivr.net/npm/vue@2.6.11/dist/vue.min.js"></script>
		<!-- Element UI -->
		<link rel="stylesheet" href="https://unpkg.com/element-ui@2.15.14/lib/theme-chalk/index.css">
		<script src="https://unpkg.com/element-ui@2.15.14/lib/index.js"></script>
		<!-- dayjs -->
		<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
		<!-- jquery -->
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

		<link rel="stylesheet" href="./css/reset.css">
		<link rel="stylesheet" href="./css/contractList.css">
	</head>
	<body>
		<!-- 页面内容区 -->
		<div class="contract" id="contract" ref="contractRef" v-cloak>
			<!-- 搜索区域 -->
			<div class="contract__search" ref="searchRef">
				<div class="contract__search_form">
					<div class="contract_row">
						<div class="contract_col_6">
							<el-input size="mini" v-model="searchForm.taskKeyword" placeholder="请输入供应商名称" />
						</div>
						<div class="contract_col_6">
							<el-select v-model="searchForm.oldGoodsKeyword" size="mini" placeholder="请选择审核状态" style="width: 100%;">
								<el-option
									v-for="item in [{value: 1, label: '已审核'}, {value: 2, label: '未审核'}, {value: 3, label: '已拒绝'}]"
									:key="item.value"
									:label="item.label"
									:value="item.value">
								</el-option>
							</el-select>
						</div>
						<div class="contract_col_6">
							<el-input size="mini" v-model="searchForm.oldSkuKeyword" placeholder="请输入商务负责人" />
						</div>
					</div>
				</div>
				<div class="contract__search_button">
					<el-button type="warning" icon="el-icon-plus" size="mini" @click="toAdd()">
						新增合同
					</el-button>
					<el-button type="primary" icon="el-icon-search" size="mini" @click="getList(true)">
						搜索
					</el-button>
					<el-button type="default" icon="el-icon-refresh-right" size="mini" plain @click="reset()">重置</el-button>
				</div>
			</div>

			<!-- 表格区域 -->
			<div class="contract__table">
				<div class="contract__table_content">
					<el-table :data="entryList" tooltip-effect="dark" size="mini" v-loading="pager.loading" :height="tableHeight">
						<el-table-column label="供应商id" width="100">
							<template slot-scope="scope">{{ scope.row.groupId }}</template>
						</el-table-column>
						<el-table-column label="供应商名称" show-overflow-tooltip>
							<template slot-scope="scope">{{ scope.row.groupName }}</template>
						</el-table-column>
						<el-table-column label="商务负责人" show-overflow-tooltip>
							<template slot-scope="scope">{{ dayjs(scope.row.createDate).format('YYYY-MM-DD HH:mm') }}</template>
						</el-table-column>
						<el-table-column label="合同编码" show-overflow-tooltip>
							<template slot-scope="scope" v-if="scope.row.updateDate">{{ dayjs(scope.row.updateDate).format('YYYY-MM-DD HH:mm') }}</template>
						</el-table-column>
						<el-table-column label="合同名称" width="80" show-overflow-tooltip>
							<template slot-scope="scope" v-if="scope.row.updateDate">{{ dayjs(scope.row.updateDate).format('YYYY-MM-DD HH:mm') }}</template>
						</el-table-column>
						<el-table-column label="合同主体" width="80" show-overflow-tooltip>
							<template slot-scope="scope" v-if="scope.row.updateDate">{{ dayjs(scope.row.updateDate).format('YYYY-MM-DD HH:mm') }}</template>
						</el-table-column>
						<el-table-column label="合同类型" width="80" show-overflow-tooltip>
							<template slot-scope="scope" v-if="scope.row.updateDate">{{ dayjs(scope.row.updateDate).format('YYYY-MM-DD HH:mm') }}</template>
						</el-table-column>
						<el-table-column label="合同有效期" width="80" show-overflow-tooltip>
							<template slot-scope="scope" v-if="scope.row.updateDate">{{ dayjs(scope.row.updateDate).format('YYYY-MM-DD HH:mm') }}</template>
						</el-table-column>
						<el-table-column label="提交时间" width="80" show-overflow-tooltip>
							<template slot-scope="scope" v-if="scope.row.updateDate">{{ dayjs(scope.row.updateDate).format('YYYY-MM-DD HH:mm') }}</template>
						</el-table-column>
						<el-table-column label="审核人" width="80" show-overflow-tooltip>
							<template slot-scope="scope" v-if="scope.row.updateDate">{{ dayjs(scope.row.updateDate).format('YYYY-MM-DD HH:mm') }}</template>
						</el-table-column>
						<el-table-column label="审核时间" width="80" show-overflow-tooltip>
							<template slot-scope="scope" v-if="scope.row.updateDate">{{ dayjs(scope.row.updateDate).format('YYYY-MM-DD HH:mm') }}</template>
						</el-table-column>
						<el-table-column label="合同状态" width="80" show-overflow-tooltip>
							<template slot-scope="scope" v-if="scope.row.updateDate">{{ dayjs(scope.row.updateDate).format('YYYY-MM-DD HH:mm') }}</template>
						</el-table-column>
						<el-table-column label="操作" width="260" fixed="right" show-overflow-tooltip>
							<template slot-scope="scope">
								<div>
									<el-button type="text" size="small" @click="toEdit(scope.row)">查看详情</el-button>
									<el-button type="text" size="small" @click="toCopy(scope.row)">查看流程</el-button>
									<el-button type="text" size="small" @click="remove(scope.$index)">合同归档</el-button>
									<el-button type="text" size="small" @click="remove(scope.$index)">下载</el-button>
								</div>
							</template>
						</el-table-column>
					</el-table>
				</div>

				<div class="contract__table_pagination" ref="paginationRef">
					<div class="contract__table_pagination_info">
						共 {{ pager.totalCount }} 条记录&nbsp;&nbsp;&nbsp;第 {{ pager.pageNo }} / {{ Math.ceil(pager.totalCount / pager.pageSize) }} 页
					</div>
					<el-pagination 
						@size-change="handleSizeChange" 
						@current-change="handleCurrentChange"
						:current-page="pager.pageNo"
						:page-sizes="[10, 20, 30, 40]" 
						:page-size="pager.pageSize"
						layout="prev, pager, next, sizes, jumper" 
						:total="pager.totalCount"
						size="mini"
					/>
				</div>
			</div>
		</div>

		<script type="module">
			// let opUrl = ctx;
			// let opUrl = 'http://newdev2.ejcop.com:1081/octopus';
			import { opUrl } from './js/contants.js';
			import  { debounce } from './js/fn.js';

			let app = new Vue({
				el: "#contract",
				data() {
					return {
						searchForm: {
							taskKeyword: "",
							oldGoodsKeyword: "",
							oldSkuKeyword: "",
						},
						pager:{
							pageNo: 1,
							pageSize: 20,
							totalCount: 0,
							loading: false
						},
						entryList: [],
						tableHeight: ''
					};
				},
				created() {
					this.getList();
				},
				mounted() {
					this.debouncedCalculateTableHeight = debounce(this.calculateTableHeight, 100);

					this.calculateTableHeight();

					window.addEventListener('resize', this.debouncedCalculateTableHeight);
				},
				beforeDestroy() {
					window.removeEventListener('resize', this.debouncedCalculateTableHeight);
				},
				methods: {
					calculateTableHeight() {
						const contractHeight = this.$refs.contractRef.offsetHeight;
						
						const searchHeight = this.$refs.searchRef.offsetHeight;
						const paginationHeight = this.$refs.paginationRef.offsetHeight;

						this.tableHeight = contractHeight - searchHeight - paginationHeight - 30;
					},
					getList(isInit) {
						if(isInit){
							this.pager.pageNo = 1;
						}
						if(this.pager.loading){
							return;
						}
						this.pager.loading = true;
						$.ajax({
							url: opUrl + "/trade/migrate/queryGroupList",
							type: "post",
							dataType: "json",
							contentType: "application/json",
							data: JSON.stringify({
								pageNo: this.pager.pageNo,
								pageSize: this.pager.pageSize,
								...this.searchForm,
							}),
							success: (res) => {
								setTimeout(() => {
										this.pager.loading = false;
								}, 500)
								if(res.code === '0000'){
									let { count, list } = res.data;
									this.entryList = [...list,...list,...list,...list,...list,...list,...list,...list,...list];
									this.pager.totalCount = count;
								}
							},
						});
					},
					reset() {
						this.searchForm =  {
							taskKeyword: "",
							oldGoodsKeyword: "",
							oldSkuKeyword: "",
						}
						this.getList(true);
					},
					handleSizeChange(val) {
						this.pager.pageSize = val;
						this.getList();
					},
					handleCurrentChange(val) {
						this.pager.pageNo = val;
						this.getList();
					},
					remove(index) {
						this.$confirm('确定删除该策略组？<br/>该操作将删除该策略组下的所有策略，请谨慎操作！', '温馨提示', {
							confirmButtonText: '确定',
							cancelButtonText: '取消',
							type: 'warning',
							dangerouslyUseHTMLString: true
						}).then(() => {
							let item = this.entryList[index];
							$.ajax({
								url: opUrl + "/trade/migrate/delTaskGroup",
								type: "post",
								dataType: "json",
								contentType: "application/json",
								data: JSON.stringify({
									groupId: item.groupId
								}),
								success: (res) => {
									this.isHandling = false;
									if(res.code === '0000'){
										this.entryList.splice(index,1);
										this.$message({
											message: '删除成功',
											type: 'success'
										});
									}else{
										this.$message.error('删除失败');
									}
								},
							});
						}).catch(() => {
		
						});
					},
					toEdit(item) {
						window.open("./groupEdit?groupId="+item.groupId)
					},
					toAdd() {
						window.open("./contractAdd.html")
					},
					toCopy(item) {
						window.open("./groupEdit?groupId="+item.groupId+"&pageType=copy")
					},
				},
			});
		
		</script>
	</body>
</html>
